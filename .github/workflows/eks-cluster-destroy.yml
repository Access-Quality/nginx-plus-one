name: EKS Cluster Destroy

on:
  workflow_dispatch:
    inputs:
      workspace_suffix:
        description: "Suffix for Terraform Cloud workspace name (eks-<suffix>)"
        required: false
      cluster_name:
        description: "Optional EKS cluster name override"
        required: false
      region:
        description: "Optional AWS region override"
        required: false

concurrency:
  group: eks-cluster
  cancel-in-progress: false

jobs:
  setup-tfc:
    runs-on: ubuntu-latest
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
    outputs:
      tf_workspace: ${{ steps.set-outputs.outputs.tf_workspace }}
      cluster_name: ${{ steps.set-outputs.outputs.cluster_name }}
      workspace_name: ${{ steps.set-outputs.outputs.workspace_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

      - name: Set dynamic vars
        shell: bash
        run: |
          set -euo pipefail
          workspace_suffix="${WORKSPACE_SUFFIX_INPUT:-}"
          if [[ -z "$workspace_suffix" ]]; then
            workspace_suffix="${GITHUB_RUN_ID}"
          fi
          workspace_name="eks-${workspace_suffix}"

          cluster_name="${CLUSTER_NAME_INPUT:-}"
          if [[ -z "$cluster_name" ]]; then
            cluster_name="${workspace_name}"
          fi

          echo "WORKSPACE_SUFFIX=${workspace_suffix}" >> "$GITHUB_ENV"
          echo "WORKSPACE_NAME=${workspace_name}" >> "$GITHUB_ENV"
          # Remote backend uses prefix 'eks-'; TF_WORKSPACE is the suffix.
          echo "TF_WORKSPACE=${workspace_suffix}" >> "$GITHUB_ENV"
          echo "CLUSTER_NAME=${cluster_name}" >> "$GITHUB_ENV"
        env:
          WORKSPACE_SUFFIX_INPUT: ${{ inputs.workspace_suffix }}
          CLUSTER_NAME_INPUT: ${{ inputs.cluster_name }}

      - name: Ensure TFC workspace
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${TFC_TOKEN:-}" || -z "${TFC_ORG:-}" ]]; then
            echo "Missing required secrets: TFC_TOKEN and/or TFC_ORG" >&2
            exit 1
          fi

          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/organizations/$TFC_ORG/workspaces/$WORKSPACE_NAME")

          if [[ "$status" == "404" ]]; then
            echo "Workspace not found in TFC: $WORKSPACE_NAME" >&2
            exit 1
          fi
          if [[ "$status" != "200" ]]; then
            echo "Unexpected status from TFC: $status" >&2
            exit 1
          fi

      - name: Set job outputs (vars)
        id: set-outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "tf_workspace=${TF_WORKSPACE}" >> "$GITHUB_OUTPUT"
          echo "workspace_name=${WORKSPACE_NAME}" >> "$GITHUB_OUTPUT"
          echo "cluster_name=${CLUSTER_NAME}" >> "$GITHUB_OUTPUT"

  terraform-plan-destroy:
    needs: setup-tfc
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      TF_WORKSPACE: ${{ needs.setup-tfc.outputs.tf_workspace }}
      CLUSTER_NAME: ${{ needs.setup-tfc.outputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

      - name: Terraform init
        working-directory: nginx-plus-one-eks/terraform/eks
        run: |
          terraform init \
            -backend-config="organization=$TFC_ORG"

      - name: Terraform validate
        working-directory: nginx-plus-one-eks/terraform/eks
        run: terraform validate

      - name: Terraform plan (destroy)
        working-directory: nginx-plus-one-eks/terraform/eks
        run: |
          terraform plan -destroy -out=/tmp/tfdestroy \
            -var="aws_region=$AWS_REGION" \
            -var="cluster_name=$CLUSTER_NAME"

      - name: Save terraform destroy plan (JSON)
        working-directory: nginx-plus-one-eks/terraform/eks
        run: |
          set -euo pipefail
          terraform show -json /tmp/tfdestroy > /tmp/tfdestroy.json || true

      - name: Upload terraform destroy plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eks-terraform-destroy-plan
          path: |
            /tmp/tfdestroy
            /tmp/tfdestroy.json
          if-no-files-found: error

  terraform-destroy:
    needs: [setup-tfc, terraform-plan-destroy]
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      TF_WORKSPACE: ${{ needs.setup-tfc.outputs.tf_workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

      - name: Download terraform destroy plan artifact
        uses: actions/download-artifact@v4
        with:
          name: eks-terraform-destroy-plan
          path: /tmp

      - name: Terraform init
        working-directory: nginx-plus-one-eks/terraform/eks
        run: |
          terraform init \
            -backend-config="organization=$TFC_ORG"

      - name: Terraform apply (destroy)
        working-directory: nginx-plus-one-eks/terraform/eks
        run: terraform apply -auto-approve /tmp/tfdestroy
