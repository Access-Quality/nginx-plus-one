name: nginx-plus-ec2

on:
  workflow_dispatch:

jobs:
  setup-tfc:
    runs-on: ubuntu-latest
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
    outputs:
      tf_workspace: ${{ steps.set-outputs.outputs.tf_workspace }}
      name_prefix: ${{ steps.set-outputs.outputs.name_prefix }}
      ssh_cidr: ${{ steps.set-outputs.outputs.ssh_cidr }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

      - name: Set dynamic vars
        shell: bash
        run: |
          set -euo pipefail
          repo_name="${GITHUB_REPOSITORY##*/}"
          echo "TFC_WORKSPACE=nginx-plus-ec2-$repo_name" >> "$GITHUB_ENV"
          echo "TF_WORKSPACE=nginx-plus-ec2-$repo_name" >> "$GITHUB_ENV"
          echo "NAME_PREFIX=nginx-plus-$repo_name" >> "$GITHUB_ENV"
          echo "SSH_CIDR=0.0.0.0/0" >> "$GITHUB_ENV"

      - name: Ensure TFC workspace
        shell: bash
        run: |
          set -euo pipefail
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TFC_TOKEN" \
            "https://app.terraform.io/api/v2/organizations/$TFC_ORG/workspaces/$TFC_WORKSPACE")

          if [[ "$status" == "404" ]]; then
            curl -sS -X POST \
              -H "Authorization: Bearer $TFC_TOKEN" \
              -H "Content-Type: application/vnd.api+json" \
              -d "{\"data\":{\"type\":\"workspaces\",\"attributes\":{\"name\":\"$TFC_WORKSPACE\",\"execution-mode\":\"local\"}}}" \
              "https://app.terraform.io/api/v2/organizations/$TFC_ORG/workspaces"
          elif [[ "$status" != "200" ]]; then
            echo "Unexpected status from TFC: $status" >&2
            exit 1
          fi

      - name: Set job outputs (vars)
        id: set-outputs
        shell: bash
        run: |
          set -euo pipefail
          repo_name="${GITHUB_REPOSITORY##*/}"
          tf_workspace="nginx-plus-ec2-$repo_name"
          name_prefix="nginx-plus-$repo_name"
          ssh_cidr="0.0.0.0/0"
          echo "tf_workspace=$tf_workspace" >> "$GITHUB_OUTPUT"
          echo "name_prefix=$name_prefix" >> "$GITHUB_OUTPUT"
          echo "ssh_cidr=$ssh_cidr" >> "$GITHUB_OUTPUT"

  terraform:
    needs: setup-tfc
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      TF_WORKSPACE: ${{ needs.setup-tfc.outputs.tf_workspace }}
      NAME_PREFIX: ${{ needs.setup-tfc.outputs.name_prefix }}
      SSH_CIDR: ${{ needs.setup-tfc.outputs.ssh_cidr }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
    outputs:
      public_ip: ${{ steps.ip.outputs.public_ip }}
      cine_private_ip: ${{ steps.ip.outputs.cine_private_ip }}
      cine_public_ip: ${{ steps.ip.outputs.cine_public_ip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write SSH public key for Terraform
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${SSH_PUBLIC_KEY:-}" ]]; then
            echo "Missing SSH_PUBLIC_KEY secret" >&2
            exit 1
          fi
          printf '%s\n' "$SSH_PUBLIC_KEY" > /tmp/ssh_key.pub

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TFC_TOKEN }}

      - name: Terraform init
        working-directory: terraform/nginx-plus-ec2
        run: |
          terraform init \
            -backend-config="organization=$TFC_ORG"

      - name: Terraform plan
        working-directory: terraform/nginx-plus-ec2
        run: |
          terraform plan -out=/tmp/tfplan \
            -var="aws_region=$AWS_REGION" \
            -var="ssh_cidr=$SSH_CIDR" \
            -var="name_prefix=$NAME_PREFIX" \
            -var="ssh_public_key=$(cat /tmp/ssh_key.pub)"

      - name: Save terraform plan (JSON)
        working-directory: terraform/nginx-plus-ec2
        run: |
          set -euo pipefail
          terraform show -json /tmp/tfplan > /tmp/tfplan.json || true

      - name: Upload terraform plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: /tmp/tfplan.json
          if-no-files-found: warn

      - name: Terraform apply
        working-directory: terraform/nginx-plus-ec2
        run: |
          terraform apply -auto-approve /tmp/tfplan

      - name: Get instance IP
        id: ip
        working-directory: terraform/nginx-plus-ec2
        run: |
          echo "public_ip=$(terraform output -raw public_ip)" >> "$GITHUB_OUTPUT"
          echo "cine_private_ip=$(terraform output -raw cine_private_ip)" >> "$GITHUB_OUTPUT"
          echo "cine_public_ip=$(terraform output -raw cine_public_ip)" >> "$GITHUB_OUTPUT"

      - name: Cleanup SSH public key file
        shell: bash
        run: |
          set -euo pipefail
          rm -f /tmp/ssh_key.pub || true

  install:
    needs: [terraform, setup-tfc]
    runs-on: ubuntu-latest
    env:
      NGINX_REPO_CRT: ${{ secrets.NGINX_REPO_CRT }}
      NGINX_REPO_KEY: ${{ secrets.NGINX_REPO_KEY }}
      LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
      LICENSE_KEY: ${{ secrets.LICENSE_KEY }}
      DATA_PLANE_KEY: ${{ secrets.DATA_PLANE_KEY }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          if [[ -z "${SSH_PRIVATE_KEY:-}" ]]; then
            echo "Missing SSH_PRIVATE_KEY secret" >&2
            exit 1
          fi
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -T 10 -H "${{ needs.terraform.outputs.public_ip }}" >> ~/.ssh/known_hosts || true

      - name: Wait for SSH
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if ssh -o BatchMode=yes -o ConnectTimeout=5 \
              -o StrictHostKeyChecking=accept-new \
              ubuntu@${{ needs.terraform.outputs.public_ip }} "true"; then
              exit 0
            fi
            sleep 10
          done
          echo "SSH not reachable after waiting." >&2
          exit 1

      - name: Upload NGINX secrets
        run: |
          if [[ -z "$NGINX_REPO_CRT" || -z "$NGINX_REPO_KEY" ]]; then
            echo "Missing NGINX repo cert/key secrets." >&2
            exit 1
          fi
          printf '%s' "$NGINX_REPO_CRT" > /tmp/nginx-repo.crt
          printf '%s' "$NGINX_REPO_KEY" > /tmp/nginx-repo.key
          printf '%s' "$LICENSE_JWT" > /tmp/license.jwt
          printf '%s' "$LICENSE_KEY" > /tmp/license.key
          scp /tmp/nginx-repo.crt ubuntu@${{ needs.terraform.outputs.public_ip }}:/tmp/nginx-repo.crt
          scp /tmp/nginx-repo.key ubuntu@${{ needs.terraform.outputs.public_ip }}:/tmp/nginx-repo.key
          scp /tmp/license.jwt ubuntu@${{ needs.terraform.outputs.public_ip }}:/tmp/license.jwt
          scp /tmp/license.key ubuntu@${{ needs.terraform.outputs.public_ip }}:/tmp/license.key

      - name: Install NGINX Plus + WAF + Agent
        run: |
          scp scripts/install-nginx-plus.sh ubuntu@${{ needs.terraform.outputs.public_ip }}:/tmp/install-nginx-plus.sh
          ssh ubuntu@${{ needs.terraform.outputs.public_ip }} \
            "sudo DATA_PLANE_KEY='$DATA_PLANE_KEY' bash /tmp/install-nginx-plus.sh"

      - name: Configure NGINX hostnames for Cine apps
        run: |
          set -euo pipefail
          BASTION="${{ needs.terraform.outputs.public_ip }}"
          CINE_PRIVATE="${{ needs.terraform.outputs.cine_private_ip }}"
          cp scripts/cine-nginx.conf /tmp/cine-nginx.conf
          sed -i "s/CINE_IP_PLACEHOLDER/${CINE_PRIVATE}/g" /tmp/cine-nginx.conf
          scp /tmp/cine-nginx.conf "ubuntu@${BASTION}:/tmp/cine-nginx.conf"
          ssh "ubuntu@${BASTION}" "sudo mv /tmp/cine-nginx.conf /etc/nginx/conf.d/cine.conf && sudo nginx -t && sudo systemctl reload nginx"

      - name: Validate WAF installation and runtime
        run: |
          set -euo pipefail
          BASTION="${{ needs.terraform.outputs.public_ip }}"
          ssh "ubuntu@${BASTION}" '
            set -euo pipefail
            echo "OS codename: $(lsb_release -cs)"
            echo "Installed packages:"
            dpkg -l | awk "\$2 ~ /nginx-plus|app-protect/ {print \$2, \$3}"
            sudo nginx -T >/tmp/nginx-full.conf 2>/tmp/nginx-test.err
            grep -q "load_module modules/ngx_http_app_protect_module.so;" /tmp/nginx-full.conf
            grep -q "app_protect_enable on;" /tmp/nginx-full.conf
            pgrep -fa bd-socket-plugin >/dev/null
            echo "WAF module loaded and runtime process detected"
            sudo tail -n 50 /var/log/nginx/error.log | grep -E "APP_PROTECT|app_protect" || true
          '

      - name: Cleanup temporary keys and secrets
        shell: bash
        run: |
          set -euo pipefail
          # remove SSH private key from runner
          if command -v shred >/dev/null 2>&1; then
            shred -u ~/.ssh/id_rsa || true
            shred -u /tmp/nginx-repo.crt /tmp/nginx-repo.key /tmp/license.jwt /tmp/license.key || true
            shred -u /tmp/tfplan /tmp/tfplan.json || true
          else
            rm -f ~/.ssh/id_rsa || true
            rm -f /tmp/nginx-repo.crt /tmp/nginx-repo.key /tmp/license.jwt /tmp/license.key || true
            rm -f /tmp/tfplan /tmp/tfplan.json || true
          fi

  build-cine-omdb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate OMDB app syntax
        run: |
          node --check scripts/cine-app.js

      - name: Upload OMDB app artifact
        uses: actions/upload-artifact@v4
        with:
          name: cine-omdb-bundle
          path: |
            scripts/cine-app.js
            scripts/cine.service

  build-cine-tmdb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate TMDB app syntax
        run: |
          node --check scripts/cine-tmdb-app.js

      - name: Upload TMDB app artifact
        uses: actions/upload-artifact@v4
        with:
          name: cine-tmdb-bundle
          path: |
            scripts/cine-tmdb-app.js
            scripts/cine-tmdb.service

  deploy-cine:
    needs: [terraform, setup-tfc, install, build-cine-omdb, build-cine-tmdb]
    runs-on: ubuntu-latest
    env:
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    steps:
      - name: Download OMDB artifact
        uses: actions/download-artifact@v4
        with:
          name: cine-omdb-bundle
          path: /tmp/cine-omdb

      - name: Download TMDB artifact
        uses: actions/download-artifact@v4
        with:
          name: cine-tmdb-bundle
          path: /tmp/cine-tmdb

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          if [[ -z "${SSH_PRIVATE_KEY:-}" ]]; then
            echo "Missing SSH_PRIVATE_KEY secret" >&2
            exit 1
          fi
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -T 10 -H "${{ needs.terraform.outputs.cine_public_ip }}" >> ~/.ssh/known_hosts || true

      - name: Wait for SSH
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if ssh -o BatchMode=yes -o ConnectTimeout=5 \
              -o StrictHostKeyChecking=accept-new \
              ubuntu@${{ needs.terraform.outputs.cine_public_ip }} "true"; then
              exit 0
            fi
            sleep 10
          done
          echo "SSH not reachable after waiting." >&2
          exit 1

      - name: Install Node.js 20
        run: |
          ssh ubuntu@${{ needs.terraform.outputs.cine_public_ip }} \
            "curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - && sudo apt-get install -y nodejs"

      - name: Resolve app artifact paths
        run: |
          set -euo pipefail
          OMDB_APP_PATH="$(find /tmp/cine-omdb -type f -name 'cine-app.js' | head -n1)"
          OMDB_SERVICE_PATH="$(find /tmp/cine-omdb -type f -name 'cine.service' | head -n1)"
          TMDB_APP_PATH="$(find /tmp/cine-tmdb -type f -name 'cine-tmdb-app.js' | head -n1)"
          TMDB_SERVICE_PATH="$(find /tmp/cine-tmdb -type f -name 'cine-tmdb.service' | head -n1)"

          if [[ -z "${OMDB_APP_PATH}" || -z "${OMDB_SERVICE_PATH}" || -z "${TMDB_APP_PATH}" || -z "${TMDB_SERVICE_PATH}" ]]; then
            echo "Artifact files not found after download" >&2
            find /tmp/cine-omdb /tmp/cine-tmdb -maxdepth 5 -type f -print || true
            exit 1
          fi

          echo "OMDB_APP_PATH=${OMDB_APP_PATH}" >> "$GITHUB_ENV"
          echo "OMDB_SERVICE_PATH=${OMDB_SERVICE_PATH}" >> "$GITHUB_ENV"
          echo "TMDB_APP_PATH=${TMDB_APP_PATH}" >> "$GITHUB_ENV"
          echo "TMDB_SERVICE_PATH=${TMDB_SERVICE_PATH}" >> "$GITHUB_ENV"

      - name: Deploy Cine app
        run: |
          set -euo pipefail
          scp "$OMDB_APP_PATH" ubuntu@${{ needs.terraform.outputs.cine_public_ip }}:/tmp/app.js
          scp "$OMDB_SERVICE_PATH" ubuntu@${{ needs.terraform.outputs.cine_public_ip }}:/tmp/cine.service
          scp "$TMDB_APP_PATH" ubuntu@${{ needs.terraform.outputs.cine_public_ip }}:/tmp/cine-tmdb-app.js
          scp "$TMDB_SERVICE_PATH" ubuntu@${{ needs.terraform.outputs.cine_public_ip }}:/tmp/cine-tmdb.service
          ssh ubuntu@${{ needs.terraform.outputs.cine_public_ip }} \
            "sudo mkdir -p /opt/cine /etc/cine /opt/cine-tmdb /etc/cine-tmdb && sudo mv /tmp/app.js /opt/cine/app.js && sudo mv /tmp/cine-tmdb-app.js /opt/cine-tmdb/app.js && sudo chown -R ubuntu:ubuntu /opt/cine /opt/cine-tmdb && echo \"OMDB_API_KEY=$OMDB_API_KEY\" | sudo tee /etc/cine/cine.env >/dev/null && echo \"TMDB_API_KEY=$TMDB_API_KEY\" | sudo tee /etc/cine-tmdb/cine-tmdb.env >/dev/null && sudo chmod 600 /etc/cine/cine.env /etc/cine-tmdb/cine-tmdb.env"

      - name: Start Cine service
        run: |
          ssh ubuntu@${{ needs.terraform.outputs.cine_public_ip }} \
            "sudo mv /tmp/cine.service /etc/systemd/system/cine.service && sudo systemctl daemon-reload && sudo systemctl enable cine && sudo systemctl start cine && sudo systemctl status cine"

      - name: Start Cine TMDB service
        run: |
          ssh ubuntu@${{ needs.terraform.outputs.cine_public_ip }} \
            "sudo mv /tmp/cine-tmdb.service /etc/systemd/system/cine-tmdb.service && sudo systemctl daemon-reload && sudo systemctl enable cine-tmdb && sudo systemctl start cine-tmdb && sudo systemctl status cine-tmdb"

      - name: Verify Cine app is running
        run: |
          ssh ubuntu@${{ needs.terraform.outputs.cine_public_ip }} \
            "echo '=== Service Status ===' && sudo systemctl status cine && sudo systemctl status cine-tmdb && echo '' && echo '=== Port Listening ===' && sudo netstat -tlnp | grep 3000 || echo 'Port 3000 not listening!' && sudo netstat -tlnp | grep 3001 || echo 'Port 3001 not listening!' && echo '' && echo '=== Recent Logs ===' && sudo journalctl -u cine -n 20 --no-pager && sudo journalctl -u cine-tmdb -n 20 --no-pager && echo '' && echo '=== Node.js version ===' && node --version"

      - name: Display Cine app URL
        run: |
          echo "âœ… Cine app deployed successfully!"
          echo "ğŸŒ Access the app at: http://${{ needs.terraform.outputs.cine_public_ip }}:3000/"
          echo "ğŸŒ Access the TMDB app at: http://${{ needs.terraform.outputs.cine_public_ip }}:3001/"
          echo "ğŸ”— NGINX Plus host routing (via ${{ needs.terraform.outputs.public_ip }}):"
          echo "   - cine.example.com -> Cine (OMDB)"
          echo "   - cine-tmdb.example.com -> Cine TMDB"
          echo "ğŸ“ Cine instance IP: ${{ needs.terraform.outputs.cine_public_ip }}"

      - name: Cleanup SSH key
        shell: bash
        run: |
          set -euo pipefail
          if command -v shred >/dev/null 2>&1; then
            shred -u ~/.ssh/id_rsa || true
          else
            rm -f ~/.ssh/id_rsa || true
          fi
