# NAP v5 decoupled WAF runtime — Hybrid configuration
# Based on: https://docs.nginx.com/waf/install/docker/#hybrid-configuration
# NGINX Plus runs on the host; waf-enforcer and waf-config-mgr run as containers.
#
# waf-enforcer: bridge network, publishes gRPC port 50000 to the host.
#   NGINX Plus reaches it at app_protect_enforcer_address 127.0.0.1:50000.
# waf-config-mgr: network_mode: none (no network needed — only file I/O).

services:
  waf-enforcer:
    image: nplus-v5-waf-enforcer:latest
    container_name: waf-enforcer
    restart: always
    environment:
      - ENFORCER_PORT=50000
    ports:
      - "50000:50000"
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
    # SYS_PTRACE is required for the tmstat shared-memory segment used for
    # internal performance counters. Without it the log line
    # "Unable to create tmstat segment" appears and the enforcer may not
    # fully initialise its statistics subsystem.
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    networks:
      - waf_network

  waf-config-mgr:
    image: nplus-v5-waf-config-mgr:latest
    container_name: waf-config-mgr
    restart: always
    network_mode: none
    volumes:
      - /opt/app_protect/bd_config:/opt/app_protect/bd_config
      - /opt/app_protect/config:/opt/app_protect/config
      - /etc/app_protect/conf:/etc/app_protect/conf
    depends_on:
      waf-enforcer:
        condition: service_started

networks:
  waf_network:
    driver: bridge
