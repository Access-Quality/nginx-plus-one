# NAP v5 (decoupled) NGINX configuration
# Key differences vs nginx-plus-ec2:
#   - app_protect_enforcer_address: connects NGINX module to the waf-enforcer container
#   - app_protect_policy_file: references compiled .tgz bundle (not a raw JSON file)
#   - app_protect_security_log_enable / app_protect_security_log: telemetry to NGINX Agent

upstream cine_backend {
    server CINE_IP_PLACEHOLDER:3000;
}

upstream cine_tmdb_backend {
    server CINE_IP_PLACEHOLDER:3001;
}

# NAP v5: enforcer runs on port 50000 (waf-enforcer container, network_mode: host)
app_protect_enforcer_address 127.0.0.1:50000;

# Increase the policy-bundle load timeout well beyond the default 45 s.
# First-time compilation with full attack signatures can take > 1 minute.
app_protect_config_set_load_timeout 300s;

# Security event logging — syslog on port 5140 is captured by NGINX Agent and
# forwarded to F5 Distributed Cloud (NGINX One Console Firewall Events / Logs).
app_protect_security_log_enable on;
app_protect_security_log "/etc/app_protect/conf/log_all.json" syslog:server=127.0.0.1:5140;

server {
    listen 80 default_server;
    server_name _ cine.example.com;

    location / {
        app_protect_enable on;
        # Source JSON policy — waf-config-mgr compiles it when NGINX sends it to
        # waf-enforcer over gRPC on startup. Do NOT reference the .tgz bundle here;
        # that is an internal artefact managed by waf-config-mgr.
        app_protect_policy_file "/opt/app_protect/config/cinex.json";

        proxy_pass http://cine_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name cine-tmdb.example.com;

    location / {
        app_protect_enable on;
        app_protect_policy_file "/opt/app_protect/config/cinex.json";

        proxy_pass http://cine_tmdb_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
