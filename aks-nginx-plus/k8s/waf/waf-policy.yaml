# ──────────────────────────────────────────────────────────────────────────────
# NGINX App Protect WAF Policy — cine namespace
# Applied to both cine.example.com and cine-tmdb.example.com via Ingress
# annotation:  nginx.org/app-protect-policy: "<namespace>/waf-policy"
# ──────────────────────────────────────────────────────────────────────────────
apiVersion: appprotect.f5.com/v1beta1
kind: APPolicy
metadata:
  name: waf-policy
  namespace: cine
spec:
  policy:
    name: waf-policy
    template:
      name: POLICY_TEMPLATE_NGINX_BASE
    applicationLanguage: utf-8
    enforcementMode: blocking
    # ── Signature sets ────────────────────────────────────────────────────────
    signature-sets:
      - name: All Signatures
        block: true
        alarm: true
      - name: High Accuracy Signatures
        block: true
        alarm: true
    # ── Violations ────────────────────────────────────────────────────────────
    # Note: VIOL_ATTACK_SIGNATURE/VIOL_SQL_INJECTION/VIOL_XSS are not valid
    # violation names in NAP v5 — signature enforcement is done via signature-sets.
    blocking-settings:
      violations:
        - name: VIOL_EVASION
          alarm: true
          block: true
        - name: VIOL_HTTP_PROTOCOL
          alarm: true
          block: true
        - name: VIOL_ENCODING
          alarm: true
          block: true
        - name: VIOL_FILETYPE
          alarm: true
          block: false
        - name: VIOL_HTTP_RESPONSE_STATUS
          alarm: true
          block: false
    # ── Allow standard HTTP methods only ─────────────────────────────────────
    methods:
      - name: GET
      - name: POST
      - name: HEAD
      - name: OPTIONS
