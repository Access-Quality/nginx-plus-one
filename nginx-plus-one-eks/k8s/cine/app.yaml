apiVersion: v1
kind: ConfigMap
metadata:
  name: cine-app
  namespace: cine
data:
  app.js: |
    const http = require("http");
    const https = require("https");
    const url = require("url");

    const PORT = process.env.PORT || 3000;
    const OMDB_API_KEY = process.env.OMDB_API_KEY || "demo";

    // Movie categories with OMDB search queries
    const categories = {
      action: "action",
      drama: "drama",
      comedy: "comedy",
      thriller: "thriller",
      scifi: "science fiction",
      horror: "horror",
    };

    function fetchMovies(searchTerm, callback) {
      const query = `https://www.omdbapi.com/?s=${encodeURIComponent(searchTerm)}&type=movie&apikey=${OMDB_API_KEY}`;

      https
        .get(query, (res) => {
          let data = "";
          res.on("data", (chunk) => (data += chunk));
          res.on("end", () => {
            try {
              const result = JSON.parse(data);
              if (result.Response === "True") {
                callback(null, result.Search || []);
              } else {
                callback(null, []);
              }
            } catch (e) {
              callback(null, []);
            }
          });
        })
        .on("error", (err) => {
          callback(null, []);
        });
    }

    const server = http.createServer((req, res) => {
      const parsedUrl = url.parse(req.url, true);
      const pathname = parsedUrl.pathname;
      const query = parsedUrl.query;

      res.setHeader("Content-Type", "text/html; charset=utf-8");

      if (pathname === "/api/movies") {
        const category = query.category || "action";
        const searchTerm = categories[category] || "action";

        fetchMovies(searchTerm, (err, movies) => {
          if (err) {
            res.writeHead(500);
            res.end(JSON.stringify({ error: "Error fetching movies" }));
            return;
          }
          res.writeHead(200, { "Content-Type": "application/json" });
          res.end(JSON.stringify(movies));
        });
      } else {
        res.writeHead(200);
        res.end(`
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <title>Cine - Pel√≠culas</title>
              <link rel="preconnect" href="https://fonts.googleapis.com">
              <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
              <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
              <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                  font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  background:
                    radial-gradient(circle at top left, #2d2f74 0%, rgba(45,47,116,0) 45%),
                    radial-gradient(circle at bottom right, #6f2dbd 0%, rgba(111,45,189,0) 40%),
                    #0f1220;
                  min-height: 100vh;
                  color: #f5f7ff;
                  padding: 24px;
                }
                .container {
                  max-width: 1240px;
                  margin: 0 auto;
                }
                .hero {
                  background: rgba(255,255,255,0.06);
                  border: 1px solid rgba(255,255,255,0.12);
                  border-radius: 24px;
                  padding: 28px;
                  backdrop-filter: blur(8px);
                  box-shadow: 0 24px 60px rgba(0,0,0,0.35);
                  margin-bottom: 24px;
                }
                h1 {
                  font-size: clamp(34px, 6vw, 54px);
                  line-height: 1.05;
                  letter-spacing: -0.03em;
                  margin-bottom: 10px;
                  text-shadow: 0 6px 20px rgba(0,0,0,0.35);
                }
                .subtitle {
                  color: rgba(245,247,255,0.78);
                  font-size: 16px;
                  font-weight: 500;
                }
                .categories {
                  display: flex;
                  gap: 10px;
                  margin-top: 18px;
                  flex-wrap: wrap;
                }
                .category-btn {
                  padding: 10px 18px;
                  border: 1px solid rgba(255,255,255,0.24);
                  border-radius: 999px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 600;
                  letter-spacing: 0.01em;
                  transition: all 0.2s ease;
                  background: rgba(255,255,255,0.08);
                  color: #f5f7ff;
                }
                .category-btn:hover {
                  border-color: rgba(255,255,255,0.4);
                  background: rgba(255,255,255,0.16);
                  transform: translateY(-1px);
                }
                .category-btn.active {
                  background: linear-gradient(135deg, #7f8cff 0%, #a855f7 100%);
                  border-color: transparent;
                  color: #fff;
                  box-shadow: 0 10px 22px rgba(138,95,255,0.35);
                }
                .movies {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                  gap: 18px;
                }
                .movie-card {
                  background: rgba(255,255,255,0.08);
                  border: 1px solid rgba(255,255,255,0.14);
                  border-radius: 16px;
                  overflow: hidden;
                  box-shadow: 0 12px 32px rgba(0,0,0,0.28);
                  transition: transform 0.25s ease, box-shadow 0.25s ease;
                }
                .movie-card:hover {
                  transform: translateY(-4px);
                  box-shadow: 0 20px 40px rgba(0,0,0,0.36);
                }
                .movie-poster {
                  width: 100%;
                  height: 320px;
                  background: linear-gradient(160deg, #1f2546 0%, #343b6a 100%);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: rgba(245,247,255,0.72);
                  font-size: 12px;
                  font-weight: 600;
                }
                .movie-info {
                  padding: 14px 14px 16px;
                }
                .movie-title {
                  font-weight: 600;
                  margin-bottom: 6px;
                  font-size: 14px;
                  color: #ffffff;
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                }
                .movie-year {
                  color: rgba(245,247,255,0.76);
                  font-size: 12px;
                  font-weight: 500;
                }
                .loading {
                  text-align: center;
                  color: rgba(245,247,255,0.9);
                  padding: 56px;
                  border: 1px dashed rgba(255,255,255,0.28);
                  border-radius: 14px;
                  font-size: 17px;
                  grid-column: 1 / -1;
                }
                .error {
                  text-align: center;
                  color: #ffd0d0;
                  background: rgba(255, 84, 84, 0.15);
                  border: 1px solid rgba(255, 84, 84, 0.35);
                  border-radius: 14px;
                  padding: 36px;
                  font-size: 16px;
                  grid-column: 1 / -1;
                }
                .footer-note {
                  margin-top: 20px;
                  text-align: center;
                  color: rgba(245,247,255,0.65);
                  font-size: 12px;
                  font-weight: 500;
                }
                @media (max-width: 680px) {
                  body { padding: 14px; }
                  .hero { padding: 18px; border-radius: 18px; }
                  .movie-poster { height: 290px; }
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="hero">
                  <h1>üé¨ Cine</h1>
                  <p class="subtitle">Explora recomendaciones por g√©nero con una experiencia m√°s visual y limpia.</p>

                  <div class="categories">
                    <button class="category-btn active" data-category="action" onclick="loadMovies('action')">Acci√≥n</button>
                    <button class="category-btn" data-category="drama" onclick="loadMovies('drama')">Drama</button>
                    <button class="category-btn" data-category="comedy" onclick="loadMovies('comedy')">Comedia</button>
                    <button class="category-btn" data-category="thriller" onclick="loadMovies('thriller')">Thriller</button>
                    <button class="category-btn" data-category="scifi" onclick="loadMovies('scifi')">Ciencia Ficci√≥n</button>
                    <button class="category-btn" data-category="horror" onclick="loadMovies('horror')">Terror</button>
                  </div>
                </div>

                <div id="content" class="movies"></div>
                <div class="footer-note">Fuente de datos: OMDb API</div>
              </div>

              <script>
                async function loadMovies(category) {
                  const content = document.getElementById('content');
                  content.innerHTML = '<div class="loading">Cargando pel√≠culas...</div>';

                  document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                  });
                  const activeButton = document.querySelector('.category-btn[data-category="' + category + '"]');
                  if (activeButton) {
                    activeButton.classList.add('active');
                  }

                  try {
                    const response = await fetch('/api/movies?category=' + category);
                    const movies = await response.json();

                    if (movies.length === 0) {
                      content.innerHTML = '<div class="error">No se encontraron pel√≠culas para esta categor√≠a</div>';
                      return;
                    }

                    content.innerHTML = movies.map(movie => {
                      const poster = movie.Poster && movie.Poster !== 'N/A' ? movie.Poster : null;
                      return `
                        <div class="movie-card">
                          <div class="movie-poster">
                            ${poster ? `<img src="${poster}" alt="${movie.Title}" style="width:100%;height:100%;object-fit:cover;">` : 'Sin p√≥ster'}
                          </div>
                          <div class="movie-info">
                            <div class="movie-title">${movie.Title}</div>
                            <div class="movie-year">${movie.Year}</div>
                          </div>
                        </div>
                      `;
                    }).join('');
                  } catch (error) {
                    content.innerHTML = '<div class="error">Error al cargar pel√≠culas. Intenta nuevamente.</div>';
                  }
                }

                loadMovies('action');
              </script>
            </body>
          </html>
        `);
      }
    });

    server.listen(PORT, "0.0.0.0", () => {
      console.log(`Cine app running on port ${PORT}`);
    });
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cine
  namespace: cine
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cine
  template:
    metadata:
      labels:
        app: cine
    spec:
      containers:
        - name: cine
          image: node:20-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
          command: ["node", "/app/app.js"]
          env:
            - name: PORT
              value: "3000"
            - name: OMDB_API_KEY
              value: "demo"
          volumeMounts:
            - name: app
              mountPath: /app
      volumes:
        - name: app
          configMap:
            name: cine-app
            items:
              - key: app.js
                path: app.js
---
apiVersion: v1
kind: Service
metadata:
  name: cine
  namespace: cine
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
spec:
  type: LoadBalancer
  selector:
    app: cine
  ports:
    - name: http
      port: 80
      targetPort: 3000
